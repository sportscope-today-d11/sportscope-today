{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="flex justify-between items-center mb-6 px-4 md:px-8">
  <h1 class="text-2xl font-bold text-gray-800">Latest News</h1>

  <div class="flex items-center gap-4">
    <select id="sort" class="border border-gray-300 rounded px-3 py-2">
      <option value="latest">Latest to Oldest</option>
      <option value="oldest">Oldest to Latest</option>
    </select>

    <!-- Tombol Lihat Bookmark -->
    <button id="toggle-bookmark-view"
            class="bg-yellow-400 text-white font-semibold px-4 py-2 rounded hover:bg-yellow-500 transition">
      My Bookmarks
    </button>
  </div>
</div>

<div id="news-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 px-4 md:px-8">
  {% include 'news_cards.html' with all_news=all_news %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const newsContainer = document.getElementById("news-container");
  const sortSelect = document.getElementById("sort");
  const bookmarkToggle = document.getElementById("toggle-bookmark-view");
  const categoryLinks = document.querySelectorAll("nav a[href*='?category=']");
  let showingBookmarks = false; // state

  async function loadNews(params = {}) {
    const url = new URL("{% url 'main:news_list_ajax' %}", window.location.origin);
    if (showingBookmarks) url.searchParams.append("bookmarked", "1");

    Object.entries(params).forEach(([key, value]) => {
      if (value) url.searchParams.append(key, value);
    });

    const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
    const data = await res.json();

    newsContainer.innerHTML = data.html;
    attachNewsEvents();
  }

  // Re-attach events setelah konten berubah
  function attachNewsEvents() {
    document.querySelectorAll(".bookmark-news").forEach(button => {
      button.addEventListener("click", async function() {
        const id = this.dataset.id;
        const res = await fetch(`/news/${id}/toggle_bookmark/`, {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": "{{ csrf_token }}",
          },
        });
        const result = await res.json();
        if (result.success) {
          this.textContent = result.status === "added" ? "★" : "☆";
        }
      });
    });
  }

  // Sorting handler
  sortSelect.addEventListener("change", () => loadNews({ sort: sortSelect.value }));

  // Kategori handler
  categoryLinks.forEach(link => {
    link.addEventListener("click", (e) => {
      e.preventDefault();
      showingBookmarks = false;
      bookmarkToggle.textContent = "My Bookmarks";
      const category = new URL(link.href).searchParams.get("category");
      loadNews({ category, sort: sortSelect.value });
    });
  });

  // Tombol "My Bookmarks"
  bookmarkToggle.addEventListener("click", () => {
    showingBookmarks = !showingBookmarks;
    bookmarkToggle.textContent = showingBookmarks ? "All News" : "My Bookmarks";
    loadNews({ sort: sortSelect.value });
  });

  attachNewsEvents();
});
</script>

{% endblock %}
